using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using RESTfull.Domain.Entities;
using RESTfull.Infrastructure.Data;
using System;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.Extensions.Logging;
using RESTfull.API.Models;

[ApiController]
[Route("api/[controller]")]
public class StudentsController : ControllerBase
{
    private readonly AppDbContext _db;
    private readonly ILogger<StudentsController> _logger;

    public StudentsController(AppDbContext db, ILogger<StudentsController> logger)
    {
        _db = db;
        _logger = logger;
    }

    [HttpGet]
    public async Task<IActionResult> GetAll([FromQuery] string? search)
    {
        // Build queryable and apply search on the database side to avoid loading everything into memory
        IQueryable<Student> query = _db.Students
            .Include(s => s.ContactInfo)
            .Include(s => s.Education)
            .Include(s => s.StudyProgram)
            .Include(s => s.StudentGroup);

        if (!string.IsNullOrWhiteSpace(search))
        {
            var q = search.Trim();
            if (int.TryParse(q, out var id))
            {
                query = query.Where(s => s.Id == id);
            }
            else
            {
                query = query.Where(s =>
                    (!string.IsNullOrEmpty(s.FirstName) && EF.Functions.Like(s.FirstName, $"%{q}%")) ||
                    (!string.IsNullOrEmpty(s.LastName) && EF.Functions.Like(s.LastName, $"%{q}%")) ||
                    (!string.IsNullOrEmpty(s.MiddleName) && EF.Functions.Like(s.MiddleName, $"%{q}%"))
                );
            }
        }

        var students = await query.ToListAsync();
        return Ok(students);
    }

    [HttpGet("{id}")]
    public async Task<IActionResult> Get(int id)
    {
        var s = await _db.Students
            .Include(st => st.ContactInfo)
            .Include(st => st.Education)
            .Include(st => st.StudyProgram)
            .Include(st => st.StudentGroup)
            .FirstOrDefaultAsync(st => st.Id == id);

        if (s == null) return NotFound();
        return Ok(s);
    }

    [HttpPost]
    public async Task<IActionResult> Create([FromBody] StudentCreateDto dto)
    {
        if (dto == null) return BadRequest("Empty payload");
        if (string.IsNullOrWhiteSpace(dto.FirstName) || string.IsNullOrWhiteSpace(dto.LastName))
            return BadRequest("FirstName and LastName are required");

        // Basic validation for study program fields (prevent creating lots of empty programs)
        if (string.IsNullOrWhiteSpace(dto.Faculty) && string.IsNullOrWhiteSpace(dto.Direction) && string.IsNullOrWhiteSpace(dto.Speciality))
        {
            return BadRequest("At least one study program field (Faculty/Direction/Speciality) must be provided.");
        }

        try
        {
            // Validate StudentGroupId if provided
            int? groupId = null;
            if (dto.StudentGroupId.HasValue)
            {
                var exists = await _db.StudentGroups.AnyAsync(g => g.Id == dto.StudentGroupId.Value);
                if (!exists)
                    return BadRequest($"StudentGroup with id {dto.StudentGroupId.Value} does not exist.");

                groupId = dto.StudentGroupId.Value;
            }

            // Get or create StudyProgram (single helper keeps logic contained)
            var sp = await GetOrCreateStudyProgramAsync(dto);

            // Create the whole object graph and save in one operation to avoid partial saves
            var student = new Student
            {
                FirstName = dto.FirstName.Trim(),
                LastName = dto.LastName.Trim(),
                MiddleName = string.IsNullOrWhiteSpace(dto.MiddleName) ? string.Empty : dto.MiddleName.Trim(),
                BirthDate = dto.BirthDate,
                StudyProgram = sp,
                StudentGroupId = groupId,
                // create empty contact and education entries attached to the student
                ContactInfo = new ContactInfo { PhoneNumber = string.Empty, Address = string.Empty },
                Education = new Education { InstitutionName = string.Empty, AdmissionYear = 0, GraduationYear = 0, Qualification = string.Empty }
            };

            _db.Students.Add(student);
            await _db.SaveChangesAsync();

            var result = await _db.Students
                .Include(s => s.ContactInfo)
                .Include(s => s.Education)
                .Include(s => s.StudyProgram)
                .Include(s => s.StudentGroup)
                .FirstOrDefaultAsync(s => s.Id == student.Id);

            return CreatedAtAction(nameof(Get), new { id = student.Id }, result);
        }
        catch (DbUpdateException dbEx)
        {
            _logger.LogError(dbEx, "Database update failed while creating student");
            return StatusCode(500, new { error = "Database update failed", detail = dbEx.Message });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Create failed");
            return StatusCode(500, new { error = "Create failed", detail = ex.Message });
        }
    }

    [HttpPut("{id}")]
    public async Task<IActionResult> Update(int id, [FromBody] StudentCreateDto dto)
    {
        if (dto == null) return BadRequest("Empty payload");
        if (string.IsNullOrWhiteSpace(dto.FirstName) || string.IsNullOrWhiteSpace(dto.LastName))
            return BadRequest("FirstName and LastName are required");

        var exists = await _db.Students.FindAsync(id);
        if (exists == null) return NotFound();

        try
        {
            // Validate StudentGroupId if provided
            int? groupId = null;
            if (dto.StudentGroupId.HasValue)
            {
                var gexists = await _db.StudentGroups.AnyAsync(g => g.Id == dto.StudentGroupId.Value);
                if (!gexists) return BadRequest($"StudentGroup with id {dto.StudentGroupId.Value} does not exist.");
                groupId = dto.StudentGroupId.Value;
            }

            var sp = await GetOrCreateStudyProgramAsync(dto);

            exists.FirstName = dto.FirstName.Trim();
            exists.LastName = dto.LastName.Trim();
            exists.MiddleName = string.IsNullOrWhiteSpace(dto.MiddleName) ? string.Empty : dto.MiddleName.Trim();
            exists.BirthDate = dto.BirthDate;
            exists.StudyProgramId = sp.Id;
            exists.StudentGroupId = groupId;

            await _db.SaveChangesAsync();
            return NoContent();
        }
        catch (DbUpdateException dbEx)
        {
            _logger.LogError(dbEx, "Database update failed while updating student");
            return StatusCode(500, new { error = "Database update failed", detail = dbEx.Message });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Update failed");
            return StatusCode(500, new { error = "Update failed", detail = ex.Message });
        }
    }

    [HttpDelete("{id}")]
    public async Task<IActionResult> Delete(int id)
    {
        var entity = await _db.Students.FindAsync(id);
        if (entity == null) return NotFound();
        _db.Students.Remove(entity);
        await _db.SaveChangesAsync();
        return NoContent();
    }

    // Helper to find or create StudyProgram in a deterministic way
    private async Task<StudyProgram> GetOrCreateStudyProgramAsync(StudentCreateDto dto)
    {
        // Normalize search fields
        var faculty = dto.Faculty?.Trim() ?? string.Empty;
        var direction = dto.Direction?.Trim() ?? string.Empty;
        var speciality = dto.Speciality?.Trim() ?? string.Empty;

        // Try to find existing one
        var sp = await _db.StudyPrograms.FirstOrDefaultAsync(x => x.Faculty == faculty && x.Direction == direction && x.Speciality == speciality);
        if (sp != null) return sp;

        // Create a new one and add to context; don't persist separately — SaveChanges will persist the whole graph
        sp = new StudyProgram
        {
            Institution = string.IsNullOrEmpty(dto.Faculty) && string.IsNullOrEmpty(dto.Direction) && string.IsNullOrEmpty(dto.Speciality) ? string.Empty : "МИРЭА",
            Faculty = faculty,
            Direction = direction,
            Speciality = speciality
        };

        _db.StudyPrograms.Add(sp);
        // Note: do not call SaveChanges here - caller will save the graph (student + sp)
        // But ensure we persist sp in cases where caller intends to only create program; here we rely on caller saving.
        return sp;
    }
}
